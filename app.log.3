2024-01-07 09:07:56,723 - app - INFO - Sending request to OpenAI: {'model': 'gpt-4-1106-preview', 'messages': [{'role': 'system', 'content': 'You are a knowledgeable assistant!!'}, {'role': 'user', 'content': 'Please review the following code:\n\nlet messages = [];\n\n\nlet systemMessages = [];\n\n\nlet model; // This variable stores the selected model name\nlet activeConversationId = null; // This will keep track of the currently selected conversation\nlet currentSystemMessage; // Default system message\nlet currentSystemMessageDescription; // Description of the current system message\nlet initialTemperature;\nlet isSaved = false; // Flag to track whether the system message changes have been saved\nlet activeSystemMessageId = null; // Variable to track the currently active system message ID\n\nfunction updateSystemMessageDropdown() {\n    let dropdownMenu = document.querySelector(\'#systemMessageModal .dropdown-menu\');\n    let dropdownButton = document.getElementById(\'systemMessageDropdown\'); // Button for the dropdown\n\n    if (!dropdownMenu || !dropdownButton) {\n        console.error("Required elements not found in the DOM.");\n        return;\n    }\n\n    // Clear existing dropdown items\n    dropdownMenu.innerHTML = \'\';\n\n    // Repopulate the dropdown menu\n    systemMessages.forEach((message, index) => {\n        let dropdownItem = document.createElement(\'button\');\n        dropdownItem.className = \'dropdown-item\';\n        dropdownItem.textContent = message.name;\n        dropdownItem.onclick = function() {\n            // Update the dropdown button text and modal content\n            dropdownButton.textContent = this.textContent; // Update the system message dropdown button text\n            document.getElementById(\'systemMessageName\').value = message.name || \'\';\n            document.getElementById(\'systemMessageDescription\').value = message.description || \'\';\n            document.getElementById(\'systemMessageContent\').value = message.content || \'\';\n            document.getElementById(\'systemMessageModal\').dataset.messageId = message.id;\n            // Update the current system message description\n            currentSystemMessageDescription = message.description;\n            // Update the temperature display\n            updateTemperatureSelectionInModal(message.temperature);\n            // Update the model dropdown in the modal and the global model variable\n            updateModelDropdownInModal(message.model_name);\n            model = message.model_name; // Update the global model variable\n        };\n        dropdownMenu.appendChild(dropdownItem);\n    });\n}\n\nfunction showModalFlashMessage(message, category) { // Usage Example: showModalFlashMessage(\'System message saved.\', \'success\');\n    var flashContainer = document.getElementById(\'modal-flash-message-container\');\n    flashContainer.innerHTML = \'\'; // Clear previous messages\n\n    var flashMessageDiv = document.createElement(\'div\');\n    flashMessageDiv.classList.add(\'alert\', `alert-${category}`, \'text-center\');\n    flashMessageDiv.textContent = message;\n\n    flashContainer.appendChild(flashMessageDiv);\n\n    // Hide the message after 3 seconds\n    setTimeout(function() {\n        flashContainer.innerHTML = \'\'; // Clear the message\n    }, 3000);\n}\n\n\nfunction checkAdminStatus(e) {\n    if (!isAdmin) {\n        e.preventDefault(); // Prevent the default action\n        $.ajax({\n            url: "/trigger-flash", // URL to a route that triggers the flash messagepopulateSystemMessageModal\n            type: "GET",\n            success: function() {\n                location.reload(); // Reload the page to display the flash message\n            }\n        });\n    } else {\n        window.location.href = \'/admin\'; // Redirect to admin dashboard if the user is an admin\n    }\n}\n\nfunction fetchAndProcessSystemMessages() {\n    return fetch(\'/api/system_messages\')\n        .then(response => response.json())\n        .then(data => {\n            systemMessages = data; // Update the systemMessages array\n\n            // Populate system message modal here\n            populateSystemMessageModal(); // Ensure this is called after systemMessages are set\n\n            // If there\'s no active system message, set it to the default\n            if (!activeSystemMessageId) {\n                const defaultSystemMessage = systemMessages.find(msg => msg.name === "Default System Message");\n                if (defaultSystemMessage) {\n                    // Set the activeSystemMessageId\n                    activeSystemMessageId = defaultSystemMessage.id;\n                }\n            }\n\n            // Find the active system message\n            const activeSystemMessage = systemMessages.find(msg => msg.id === activeSystemMessageId);\n            if (activeSystemMessage) {\n                // Display the active system message\n                displaySystemMessage(activeSystemMessage.content);\n            } else {\n                // If there\'s no active system message, display the first system message\n                displaySystemMessage(systemMessages[0].content);\n            }\n        })\n        .catch(error => {\n            console.error(\'Error fetching system messages:\', error);\n        });\n}\n\n\n\n// Add this code to the beginning of your script\ndocument.querySelectorAll(\'input[name="temperatureOptions"]\').forEach(radio => {\n    radio.addEventListener(\'change\', function() {\n        selectedTemperature = parseFloat(this.value);\n        console.log("Temperature changed via radio button to:", selectedTemperature);\n    });\n});\n\n\n$(\'#systemMessageModal\').on(\'show.bs.modal\', function (event) {\n    // Reset isSaved to false whenever the modal is shown\n    isSaved = false;\n});\n\n$(\'#systemMessageModal\').on(\'hide.bs.modal\', function (event) {\n    if (!isSaved) {\n        selectedTemperature = initialTemperature;\n        console.log("Modal closed without saving. Restoring temperature to:", initialTemperature);\n\n        // Reset the system message in the modal to the active system message\n        if (activeSystemMessageId) {\n            const activeSystemMessage = systemMessages.find(msg => msg.id === activeSystemMessageId);\n            if (activeSystemMessage) {\n                document.getElementById(\'systemMessageName\').value = activeSystemMessage.name;\n                document.getElementById(\'systemMessageDescription\').value = activeSystemMessage.description;\n                document.getElementById(\'systemMessageContent\').value = activeSystemMessage.content;\n                document.getElementById(\'modalModelDropdownButton\').dataset.apiName = activeSystemMessage.model_name;\n                // Update dropdown button text to reflect the active system message\n                document.getElementById(\'systemMessageDropdown\').textContent = activeSystemMessage.name;\n\n                // Log the reset\n                console.log("Modal content reset to active system message:", activeSystemMessage.name);\n            }\n        }\n    }\n});\n\n\n\nfunction toggleTemperatureSettings() {\n    var temperatureLabel = document.getElementById(\'temperatureLabel\');\n    var temperatureOptions = document.getElementById(\'temperatureOptions\');\n    var systemMessageContentGroup = document.getElementById(\'systemMessageContentGroup\');\n\n    if (temperatureOptions.style.display === \'none\') {\n        temperatureLabel.style.display = \'block\';\n        temperatureOptions.style.display = \'block\';\n        systemMessageContentGroup.style.display = \'none\';\n    } else {\n        temperatureLabel.style.display = \'none\';\n        temperatureOptions.style.display = \'none\';\n        systemMessageContentGroup.style.display = \'block\';\n    }\n}\n\n\n\n\ndocument.getElementById(\'saveSystemMessageChanges\').addEventListener(\'click\', function() {\n    console.log("Before saving system message, selectedTemperature:", selectedTemperature);\n    const messageName = document.getElementById(\'systemMessageName\').value;\n    const messageDescription = document.getElementById(\'systemMessageDescription\').value;\n    const messageContent = document.getElementById(\'systemMessageContent\').value;\n    const modelName = document.getElementById(\'modalModelDropdownButton\').dataset.apiName;\n    const temperature = selectedTemperature;\n\n    const messageId = document.getElementById(\'systemMessageModal\').dataset.messageId;\n\n    if (messageId) {\n        // Updating an existing system message\n        $.ajax({\n            url: `/system-messages/${messageId}`,\n            method: \'PUT\',\n            contentType: \'application/json\',\n            data: JSON.stringify({\n                name: messageName,\n                description: messageDescription,\n                content: messageContent,\n                model_name: modelName,\n                temperature: temperature\n            }),\n            success: function(response) {\n                console.log(\'System message updated successfully:\', response);\n\n                // Update the corresponding system message in the array\n                const updatedIndex = systemMessages.findIndex(msg => msg.id === messageId);\n                if (updatedIndex !== -1) {\n                    systemMessages[updatedIndex] = response; // Assuming the response contains the updated message\n                }\n\n                // Refresh the dropdown menu to reflect the changes\n                updateSystemMessageDropdown();\n\n                // Update the selected temperature and the temperature display\n                selectedTemperature = temperature;\n                console.log("Temperature after AJAX response:", selectedTemperature);\n                updateTemperatureDisplay();\n\n                // Update the model dropdown on the main page\n                $(\'#dropdownMenuButton\').text(modelNameMapping(modelName));\n\n                // Update the system message display\n                displaySystemMessage(messageContent);\n\n                $(\'#systemMessageModal\').modal(\'hide\');\n            },\n            error: function(error) {\n                console.error(\'Error updating system message:\', error);\n            }\n        });\n    } else {\n        // Creating a new system message\n        $.ajax({\n            url: `/system-messages`,\n            method: \'POST\',\n            contentType: \'application/json\',\n            data: JSON.stringify({\n                name: messageName,\n                description: messageDescription,\n                content: messageContent,\n                model_name: modelName,\n                temperature: temperature\n            }),\n            success: function(response) {\n                console.log(\'System message created successfully:\', response);\n\n                // Add the new system message to the array\n                systemMessages.push(response);\n\n                // Refresh the dropdown menu to reflect the new message\n                updateSystemMessageDropdown();\n\n                // Update the selected temperature and the temperature display\n                selectedTemperature = temperature;\n                console.log("Temperature after AJAX response:", selectedTemperature);\n                updateTemperatureDisplay();\n\n                // Update the model dropdown on the main page\n                $(\'#dropdownMenuButton\').text(modelNameMapping(modelName));\n\n                // Update the system message display\n                displaySystemMessage(messageContent);\n\n                $(\'#systemMessageModal\').modal(\'hide\');\n            },\n            error: function(error) {\n                console.error(\'Error creating system message:\', error);\n            }\n        });\n    }\n});\n\n\n\n\nfunction updateTemperatureSelectionInModal(temperature) {\n    console.log("Updating temperature in modal to:", temperature);\n    selectedTemperature = temperature;\n    document.querySelectorAll(\'input[name="temperatureOptions"]\').forEach(radio => {\n        radio.checked = parseFloat(radio.value) === parseFloat(temperature);\n    });\n    updateTemperatureDisplay(); // Update the display to reflect the change\n}\n\n// Function to populate the system message modal\nfunction populateSystemMessageModal() {\n    let dropdownMenu = document.querySelector(\'#systemMessageModal .dropdown-menu\');\n    let dropdownButton = document.getElementById(\'systemMessageDropdown\'); // Button for the dropdown\n\n    if (!dropdownMenu || !dropdownButton) {\n        console.error("Required elements not found in the DOM.");\n        return;\n    }\n\n    // Clear existing dropdown items\n    dropdownMenu.innerHTML = \'\';\n\n    // Add each system message to the dropdown\n    systemMessages.forEach((message, index) => {\n        console.log(\'System message:\', message);\n        console.log(`System message [${message.name}] temperature:`, message.temperature); \n        let dropdownItem = document.createElement(\'button\');\n        dropdownItem.className = \'dropdown-item\';\n        dropdownItem.textContent = message.name;\n        dropdownItem.onclick = function() {\n            // Update the dropdown button text and modal content\n            dropdownButton.textContent = this.textContent; // Update the system message dropdown button text\n            document.getElementById(\'systemMessageName\').value = message.name || \'\';\n            document.getElementById(\'systemMessageDescription\').value = message.description || \'\';\n            document.getElementById(\'systemMessageContent\').value = message.content || \'\';\n            document.getElementById(\'systemMessageModal\').dataset.messageId = message.id;\n            // Update the current system message description\n            currentSystemMessageDescription = message.description;\n            // Update the temperature display\n            console.log(`Dropdown item clicked for [${message.name}], setting temperature to:`, message.temperature);\n            initialTemperature = message.temperature;\n            selectedTemperature = message.temperature;\n            updateTemperatureSelectionInModal(message.temperature);\n            // Update the model dropdown in the modal and the global model variable\n            updateModelDropdownInModal(message.model_name);\n            model = message.model_name; // Update the global model variable\n            console.log(\'Model updated to:\', model);\n\n            editSystemMessage = message; // Set the editSystemMessage variable to the selected system message\n        };\n        dropdownMenu.appendChild(dropdownItem);\n    });\n\n    // Pre-select and display the default system message only if there\'s no active system message\n    if (!activeSystemMessageId) {\n        const defaultSystemMessage = systemMessages.find(msg => msg.name === "Default System Message");\n        if (defaultSystemMessage) {\n            dropdownButton.textContent = defaultSystemMessage.name;\n            document.getElementById(\'systemMessageDescription\').value = defaultSystemMessage.description || \'\';\n            document.getElementById(\'systemMessageContent\').value = defaultSystemMessage.content || \'\';\n            document.getElementById(\'systemMessageModal\').dataset.messageId = defaultSystemMessage.id;\n\n            // Set the temperature to the default system message\'s temperature\n            initialTemperature = defaultSystemMessage.temperature;\n            updateTemperatureSelectionInModal(initialTemperature);\n        }\n    }    \n}\n\nfunction updateTemperatureDisplay() {\n    // Get the value of the currently selected temperature\n    const selectedTemperatureValue = document.querySelector(\'input[name="temperatureOptions"]:checked\').value;\n\n    // Get the short description for the selected temperature\n    const selectedTemperatureDescription = temperatureDescriptions[selectedTemperatureValue];\n\n    // Update the temperature display\n    document.getElementById(\'temperatureDisplay\').textContent = \'Temperature: \' + selectedTemperatureDescription;\n}\n\nfunction displaySystemMessage(messageContent) {\n    currentSystemMessage = messageContent; // Update the current system message\n    let systemMessageButton = createSystemMessageButton();\n    const renderedContent = renderOpenAI(messageContent) + systemMessageButton;\n\n    // Update the UI\n    document.getElementById(\'system-message-selection\').innerHTML = \'<div class="system-message">System: \' + renderedContent + \'</div>\';\n\n    // Update the message in the \'messages\' array\n    if (messages.length > 0 && messages[0].role === "system") {\n        messages[0].content = messageContent;\n    } else {\n        // If there\'s no existing system message at the start of the array, add it\n        messages.unshift({\n            role: "system",\n            content: messageContent\n        });\n    }\n}\n\n\n\ndocument.getElementById(\'delete-system-message-btn\').addEventListener(\'click\', function() {\n    const messageId = document.getElementById(\'systemMessageModal\').dataset.messageId;\n\n    if (messageId) {\n        if (confirm(\'Are you sure you want to delete this system message?\')) {\n            $.ajax({\n                url: `/system-messages/${messageId}`,\n                method: \'DELETE\',\n                success: function(response) {\n                    console.log(\'System message deleted successfully:\', response);\n\n                    // Show the flash message in the modal\n                    showModalFlashMessage(\'System message has been deleted\', \'success\');\n\n                    // Find and set the System Default Message as the active message\n                    const defaultSystemMessage = systemMessages.find(msg => msg.name === "Default System Message");\n                    if (defaultSystemMessage) {\n                        activeSystemMessageId = defaultSystemMessage.id;\n                        document.getElementById(\'systemMessageName\').value = defaultSystemMessage.name;\n                        document.getElementById(\'systemMessageDescription\').value = defaultSystemMessage.description;\n                        document.getElementById(\'systemMessageContent\').value = defaultSystemMessage.content;\n                        document.getElementById(\'modalModelDropdownButton\').dataset.apiName = defaultSystemMessage.model_name;\n                        selectedTemperature = defaultSystemMessage.temperature;\n                        updateTemperatureSelectionInModal(defaultSystemMessage.temperature);\n                        updateModelDropdownInModal(defaultSystemMessage.model_name);\n                    } else {\n                        console.error(\'Default System Message not found\');\n                    }\n                },\n                error: function(error) {\n                    console.error(\'Error deleting system message:\', error);\n                    showModalFlashMessage(\'Error deleting system message\', \'danger\');\n                }\n            });\n        }\n    } else {\n        console.error(\'System message ID not found for deletion\');\n        showModalFlashMessage(\'System message ID not found\', \'danger\');\n    }\n});\n\n\ndocument.getElementById(\'new-system-message-btn\').addEventListener(\'click\', function() {\n    // Clear all the fields in the modal\n    document.getElementById(\'systemMessageName\').value = \'\';\n    document.getElementById(\'systemMessageDescription\').value = \'\';\n    document.getElementById(\'systemMessageContent\').value = \'\';\n\n    // Clear the messageId from the modal\'s data attributes\n    document.getElementById(\'systemMessageModal\').dataset.messageId = \'\';\n\n    // Set the model to GPT-3.5\n    document.getElementById(\'modalModelDropdownButton\').textContent = \'GPT-3.5\';\n    document.getElementById(\'modalModelDropdownButton\').dataset.apiName = \'gpt-3.5-turbo-0613\';\n\n    // Set the temperature to .07\n    document.querySelector(\'input[name="temperatureOptions"][value="0.7"]\').checked = true;\n    updateTemperatureDisplay();\n});\n\n$(window).on(\'load\', function () {\n    // Fetch the current model_name from the backend when the page loads\n    $.ajax({\n        url: \'/get-current-model\',\n        method: \'GET\',\n        success: function(response) {\n            const apiModelName = response.model_name;\n            const userFriendlyModelName = modelNameMapping(apiModelName);\n\n            // Set the model variable to the actual model name used for API calls\n            model = apiModelName;\n            \n            // Update the model dropdown on the main page with the user-friendly name\n            $(\'#dropdownMenuButton\').text(userFriendlyModelName);\n            $(\'#dropdownMenuButton\').show();\n\n                // After successfully setting the model, call updateConversationList\n                updateConversationList();\n        },\n        error: function(error) {\n            console.error(\'Error fetching current model:\', error);\n        }\n    });\n});\n\n\n$(\'.dropdown-item\').on(\'click\', function(event){\n        event.preventDefault();  // Prevent the # appearing in the URL\n        $(\'#dropdownMenuButton\').text($(this).text());\n        model = $(this).attr(\'data-model\'); // Update the model variable here\n        console.log("Dropdown item clicked. Model is now: " + model);\n});\n\n\ndocument.querySelectorAll(\'input[name="temperatureOptions"]\').forEach((radioButton) => {\n    radioButton.addEventListener(\'change\', updateTemperatureDisplay);\n});\n\n// Mapping between temperature values and their short descriptions\nconst temperatureDescriptions = {\n    \'0\': \'0 (Zero) - Deterministic\',\n    \'0.3\': \'0.3 - Low Variability\',\n    \'0.7\': \'0.7 - Balanced Creativity\',\n    \'1.0\': \'1.0 - High Creativity\',\n    \'1.5\': \'1.5 - Experimental\'\n};\n\n\n\n\n// Helper function to map model names to their display values\nfunction modelNameMapping(modelName) {\n    switch(modelName) {\n        case "gpt-3.5-turbo-0613": return "GPT-3.5";\n        case "gpt-4-0613": return "GPT-4 (8k)";\n        case "gpt-4-1106-preview": return "GPT-4 (128K)"; \n        default: return "Unknown Model"; // Handle any unexpected values\n    }\n}\n\n// Function to populate the model dropdown in the modal\nfunction populateModelDropdownInModal() {\n    const modalModelDropdownMenu = document.querySelector(\'#systemMessageModal .model-dropdown-container .dropdown-menu\');\n\n    if (!modalModelDropdownMenu) {\n        console.error("Required elements not found in the DOM.");\n        return;\n    }\n\n    // Clear existing dropdown items\n    modalModelDropdownMenu.innerHTML = \'\';\n\n    // Define the available models\n    const models = ["gpt-3.5-turbo-0613", "gpt-4-0613", "gpt-4-1106-preview"]; \n\n    // Add each model to the dropdown\n    models.forEach((modelItem) => {\n        let dropdownItem = document.createElement(\'button\');\n        dropdownItem.className = \'dropdown-item\';\n        dropdownItem.textContent = modelNameMapping(modelItem);\n        dropdownItem.dataset.apiName = modelItem;\n        dropdownItem.onclick = function() {\n            // Update the dropdown button text and modal content\n            let dropdownButton = document.getElementById(\'modalModelDropdownButton\');\n            dropdownButton.textContent = this.textContent;\n            dropdownButton.dataset.apiName = this.dataset.apiName;\n            console.log(\'Model selected in modal:\', this.dataset.apiName);\n\n            // Update the global model variable\n            model = this.dataset.apiName;\n            console.log(\'Global model variable updated to:\', model);\n        };\n        \n        modalModelDropdownMenu.appendChild(dropdownItem);\n    });\n}\n\n\n\nfunction updateModelDropdownInModal(modelName) {\n    const userFriendlyModelName = modelNameMapping(modelName);\n    const modelDropdownButton = document.getElementById(\'modalModelDropdownButton\');\n    \n    modelDropdownButton.textContent = userFriendlyModelName;\n    modelDropdownButton.dataset.apiName = modelName;\n}\n\n\n// Example usage when a system message is selected or modal is opened\nupdateModelDropdownInModal(\'GPT-3.5\'); // Update with the actual model name\n\n$(\'#systemMessageModal\').on(\'show.bs.modal\', function (event) {\n    isSaved = false; // Reset the isSaved flag whenever the modal is shown\n    // Check if there\'s an active system message\n    if (activeSystemMessageId) {\n        const activeSystemMessage = systemMessages.find(msg => msg.id === activeSystemMessageId);\n        if (activeSystemMessage) {\n            initialTemperature = activeSystemMessage.temperature; // Corrected variable name here\n            console.log("Modal opened. Initial temperature set to:", initialTemperature);\n            // Set the modal fields to the values of the active system message\n            document.getElementById(\'systemMessageName\').value = activeSystemMessage.name;\n            document.getElementById(\'systemMessageDescription\').value = activeSystemMessage.description;\n            document.getElementById(\'systemMessageContent\').value = activeSystemMessage.content;\n            document.getElementById(\'modalModelDropdownButton\').dataset.apiName = activeSystemMessage.model_name;\n            selectedTemperature = activeSystemMessage.temperature;\n            console.log("System Message Modal shown. Current Temperature:", selectedTemperature);\n\n            // Update the model dropdown and the temperature display\n            updateModelDropdownInModal(activeSystemMessage.model_name);\n            updateTemperatureDisplay();\n        }\n    }\n\n    populateSystemMessageModal(); // Populate dropdown and set default description\n    populateModelDropdownInModal(); // Populate the model dropdown\n});\n\n\n\n\n// Function to open the modal and set the user ID and current status\nfunction openStatusModal(userId, currentStatus) {\n    // Set the action URL for the form\n    document.getElementById(\'statusUpdateForm\').action = `/update-status/${userId}`;\n\n    // Check the radio button that matches the current status\n    if (currentStatus === \'Active\') {\n        document.getElementById(\'statusActive\').checked = true;\n    } else if (currentStatus === \'Pending\') {\n        document.getElementById(\'statusPending\').checked = true;\n    } else {\n        document.getElementById(\'statusNA\').checked = true;\n    }\n\n    // Open the modal\n    $(\'#statusUpdateModal\').modal(\'show\');\n}\n\n// Function to submit the form\nfunction updateStatus() {\n    document.getElementById(\'statusUpdateForm\').submit();\n}\n\n// System message temperature adjust button\ndocument.getElementById("modalTemperatureAdjustBtn").addEventListener("click", function() {\n    $(\'#temperatureModal\').modal(\'show\');\n});\n\n// Main temperature adjust button\ndocument.getElementById("temperature-adjust-btn").addEventListener("click", function() {\n    $(\'#systemMessageModal\').modal(\'show\'); // Open the system message modal\n\n    // Function to toggle temperature settings visibility\n    function toggleTemperatureSettings(show) {\n        var temperatureLabel = document.getElementById(\'temperatureLabel\');\n        var temperatureOptions = document.getElementById(\'temperatureOptions\');\n        var systemMessageContentGroup = document.getElementById(\'systemMessageContentGroup\');\n\n        if (show) {\n            temperatureLabel.style.display = \'block\';\n            temperatureOptions.style.display = \'block\';\n            systemMessageContentGroup.style.display = \'none\';\n        } else {\n            temperatureLabel.style.display = \'none\';\n            temperatureOptions.style.display = \'none\';\n            systemMessageContentGroup.style.display = \'block\';\n        }\n    }\n\n    // Ensure the temperature options are visible\n    toggleTemperatureSettings(true);\n});\n\n\n// let selectedTemperature = 0.7; // Default temperature value\nlet selectedTemperature;\n\n\n\n\n\nfunction createSystemMessageButton() {\n    return `<button class="btn btn-sm" id="systemMessageButton" style="color: white;"><i class="fa-regular fa-pen-to-square"></i></button>`;\n}\n\n// Handle the click event on the system message button\ndocument.addEventListener(\'click\', function(event) {\n    if (event.target && event.target.closest(\'#systemMessageButton\')) {\n        $(\'#systemMessageModal\').modal(\'show\'); // Open the system message modal\n\n        // Function to toggle temperature settings visibility\n        function toggleTemperatureSettings(show) {\n            var temperatureLabel = document.getElementById(\'temperatureLabel\');\n            var temperatureOptions = document.getElementById(\'temperatureOptions\');\n            var systemMessageContentGroup = document.getElementById(\'systemMessageContentGroup\');\n\n            if (show) {\n                temperatureLabel.style.display = \'block\';\n                temperatureOptions.style.display = \'block\';\n                systemMessageContentGroup.style.display = \'none\';\n            } else {\n                temperatureLabel.style.display = \'none\';\n                temperatureOptions.style.display = \'none\';\n                systemMessageContentGroup.style.display = \'block\';\n            }\n        }\n\n        // Ensure the system message content is visible\n        toggleTemperatureSettings(false);\n    }\n});\n\n\n// Existing logic to display the system message when the page loads\ndocument.addEventListener("DOMContentLoaded", function() {\n    if (!activeConversationId && $(\'#chat\').children().length === 0) {\n        displaySystemMessage(systemMessages[0].content);\n    }\n});\n\n// Add event listener to model dropdown to handle model changes\ndocument.addEventListener(\'change\', function(event) {\n    if (event.target && event.target.id === \'model-dropdown\') {\n        // Logic to handle model change\n        let selectedModel = systemMessages[event.target.value];\n        displaySystemMessage(selectedModel.content);\n        // Additional logic to switch the conversation to the selected model\n    }\n});\n\n\n\ndocument.addEventListener(\'click\', function(event) {\n    if (event.target && event.target.id === \'add-system-message-btn\') {\n        // Logic to handle adding a new system message\n    }\n});\n\n\ndocument.addEventListener("DOMContentLoaded", populateSystemMessageModal);\n\ndocument.addEventListener(\'click\', function(event) {\n    if (event.target && event.target.closest(\'#systemMessageButton\')) {\n        $(\'#systemMessageModal\').modal(\'show\'); // Show the modal when the button is clicked\n    }\n});\n\n\nfunction detectAndRenderMarkdown(content) {\n    // Check for headers, lists, links, etc.\n    const markdownPatterns = [\n        /^# .+/gm,       // Headers\n        /^\\* .+/gm,      // Unordered lists\n        /^\\d+\\. .+/gm,   // Ordered lists\n        /\\[.+\\]\\(.+\\)/g // Links\n    ];\n\n    let containsMarkdown = false;\n    for (let pattern of markdownPatterns) {\n        if (pattern.test(content)) {\n            containsMarkdown = true;\n            break;\n        }\n    }\n\n    // If potential markdown structures are detected, process the content with the Markdown parser\n    if (containsMarkdown) {\n        // Avoid processing content inside triple backticks\n        const codeBlockRegex = /```[\\s\\S]*?```/g;\n        const codeBlocks = [...content.matchAll(codeBlockRegex)];\n\n        content = content.replace(codeBlockRegex, \'%%%CODE_BLOCK%%%\'); // Temporary placeholder\n\n        content = marked.parse(content);\n\n        // Restore code blocks\n        let blockIndex = 0;\n        content = content.replace(/%%%CODE_BLOCK%%%/g, () => {\n            return codeBlocks[blockIndex++] && codeBlocks[blockIndex - 1][0];\n        });\n    }\n\n    return content;\n}\n\n// This function renders the content inside triple backticks - the OpenAI Playground style.\nfunction renderOpenAI(content) {\n    console.log(\'renderOpenAI called with content:\', content);\n\n    // First, check for potential markdown structures and process them\n    content = detectAndRenderMarkdown(content);\n\n    // Insert a line break before the first numbered item\n    let isFirstNumberedItem = true;\n    content = content.replace(/\\n\\n(\\d+\\. )/g, (match, p1) => {\n        if (isFirstNumberedItem) {\n            isFirstNumberedItem = false;\n            return \'<br><br>\\n\\n\' + p1;\n        }\n        return match;\n    });\n\n    // Insert an additional newline between numbered list items\n    content = content.replace(/(\\n)(\\d+\\. )/g, \'\\n\\n$2\');\n\n    // Regular expression to match content inside triple backticks, capturing the optional language declaration\n    const regex = /```(\\w+)?([\\s\\S]*?)```/g;\n\n    // Function to process matched content\n    const replacer = (match, lang, p1) => {\n        console.log(\'Matched content inside backticks with language:\', lang, \'Content:\', p1.trim());\n    \n        let renderedContent;\n        if (!lang || lang === \'markdown\') {\n            // If no language is provided or the language is markdown, process it with the Markdown parser\n            renderedContent = marked.parse(p1.trim());\n        } else {\n            // Otherwise, treat it as a code block\n            renderedContent = \'<pre><code class="\' + (lang ? \'language-\' + lang : \'\') + \'">\' + p1.trim() + \'</code></pre>\';\n        }\n        console.log(\'Rendered Content:\', renderedContent);\n        \n        // Create a temporary element to hold the rendered content\n        const tempElement = document.createElement(\'div\');\n        tempElement.innerHTML = renderedContent;\n    \n        // Apply Prism highlighting to the content inside the temporary element\n        Prism.highlightAllUnder(tempElement);\n    \n        // Log Prism highlighting to the content inside the temporary element\n        console.log(\'Highlighted content:\', tempElement.innerHTML);\n    \n        // Return the highlighted content\n        return tempElement.innerHTML || match; // Ensure we return the original match if nothing else\n    };\n    \n\n    // Replace content inside triple backticks with processed content\n    const processedContent = content.replace(regex, replacer);\n    console.log(\'Final processed content:\', processedContent);\n\n    return processedContent;\n}\n\n\nfunction updateConversationList() {\n    console.log(\'Starting to update conversation list...\');\n    fetch(\'/api/conversations\')\n        .then(response => {\n            if (!response.ok) {\n                throw new Error(`HTTP error! Status: ${response.status}`);\n            }\n            return response.json();\n        })\n        .then(data => {\n            console.log(`Received ${data.length} conversations from server.`);\n\n            // Prepare new HTML content for conversation list\n            let newConversationListContent = \'\';\n            // Add each conversation to the new content.\n            data.forEach((conversation, index) => {\n                const temperatureInfo = (typeof conversation.temperature !== \'undefined\' && conversation.temperature !== null) ? `${conversation.temperature}°` : \'N/A°\';\n                newConversationListContent += `\n                    <div class="conversation-item" data-id="${conversation.id}">\n                        <div class="conversation-title">${conversation.title}</div>\n                        <div class="conversation-meta">\n                            <span class="model-name" title="AI Model used for this conversation">${conversation.model_name}</span>\n                            <span class="temperature-info" title="Temperature setting">${temperatureInfo}</span>\n                        </div>\n                    </div>\n                `;\n            });\n            \n            // Replace conversation list content with new content\n            $(\'#conversation-list\').html(newConversationListContent);\n            console.log(\'Conversation list updated.\');\n\n            // Add click event handlers to the conversation elements.\n            $(\'.conversation-item\').click(function() {\n                const conversationId = $(this).data(\'id\');\n                console.log(`Loading conversation with id: ${conversationId}`);\n                \n                // Update the URL to reflect the conversation being loaded\n                window.history.pushState({}, \'\', `/c/${conversationId}`);\n\n                // Load the conversation data\n                loadConversation(conversationId);\n            });\n        })\n        .catch(error => {\n            console.error(`Error updating conversation list: ${error}`);\n        });\n}\n\n\n\n$(\'#edit-title-btn\').click(function() {\n    const newTitle = prompt(\'Enter new conversation title:\', $(\'#conversation-title\').text());\n    if (newTitle) {\n        $.ajax({\n            url: `/api/conversations/${activeConversationId}/update_title`,\n            method: \'POST\',\n            contentType: \'application/json\',\n            data: JSON.stringify({ title: newTitle }),\n            success: function(response) {\n                $(\'#conversation-title\').text(newTitle);\n                \n                // Update the title in the sidebar\n                const targetConversationItem = $(`.conversation-item[data-id="${activeConversationId}"] .conversation-title`);\n                \n                // Log for debugging purposes\n                console.log(\'Attempting to update sidebar title for conversation ID:\', activeConversationId);\n                console.log(\'Targeted element:\', targetConversationItem);\n                \n                targetConversationItem.text(newTitle);\n            },\n            error: function(error) {\n                console.error("Error updating title:", error);\n            }\n        });\n    }\n});\n\n\n$(\'#delete-conversation-btn\').click(function() {\n    const confirmation = confirm(\'Are you sure you want to delete this conversation? This action cannot be undone.\');\n    if (confirmation) {\n        $.ajax({\n            url: `/api/conversations/${activeConversationId}`,\n            method: \'DELETE\',\n            success: function(response) {\n                // Upon successful deletion, redirect to the main URL.\n                window.location.href = \'/\';\n            },\n            error: function(error) {\n                console.error("Error deleting conversation:", error);\n            }\n        });\n    }\n});\n\n\n\n// This function shows the conversation controls (title, rename and delete buttons)\nfunction showConversationControls(title = "AI &infin; UI", tokens = {prompt: 0, completion: 0, total: 0}) {\n    // Update the title\n    console.log("Inside showConversationControls function. Title:", title);\n    console.log("Inside showConversationControls. Tokens:", tokens);\n\n    $("#conversation-title").html(title);\n    $("#conversation-title, #edit-title-btn, #delete-conversation-btn").show();\n\n    // Update token data\n    $("#prompt-tokens").text(`Prompt Tokens: ${tokens.prompt}`);\n    $("#completion-tokens").text(`Completion Tokens: ${tokens.completion}`);\n    $("#total-tokens").text(`Total Tokens: ${tokens.total}`);\n}\n\n\n// This function fetchs and displays a conversation.\nfunction loadConversation(conversationId) {\n    console.log(`Fetching conversation with id: ${conversationId}...`);\n    fetch(`/conversations/${conversationId}`)\n        .then(response => {\n            console.log(\'Response received for conversation fetch\', response);\n            if (!response.ok) {\n                throw new Error(`HTTP error! Status: ${response.status}`);\n            }\n            return response.json();\n        })\n        .then(data => {\n            // Update the conversation title in the UI\n            $(\'#conversation-title\').text(data.title);\n            \n            // Update the messages array with the conversation history\n            \n            console.log(\'Parsed JSON data from conversation:\', data);\n\n            messages = data.history;\n            \n            console.log(`Received conversation data for id: ${conversationId}`);\n        \n            console.log(\'Token Count:\', data.token_count);\n\n            console.log("Retrieved model name:", data.model_name);  // Log the retrieved model name\n\n            // Update the dropdown display based on the model name from the conversation\n            const modelName = data.model_name;\n            $(\'.current-model-btn\').text(modelNameMapping(modelName));\n            // Also update the global model variable\n            model = modelName;\n\n            // Retrieve and handle the temperature setting\n            selectedTemperature = data.temperature ?? 0.7; // Use the temperature from the data, or default to 0.7 if it\'s null/undefined\n\n            // Update the token data in the UI\n            const tokenCount = data.token_count || 0;\n            showConversationControls(data.title || "AI &infin; UI", {prompt: 0, completion: 0, total: tokenCount});\n\n            // Save this conversation id as the active conversation\n            activeConversationId = conversationId;\n            \n            // Update the UI to reflect the fetched temperature\n            document.querySelectorAll(\'input[name="temperatureOptions"]\').forEach(radio => {\n                if (parseFloat(radio.value) === parseFloat(selectedTemperature)) {\n                    radio.checked = true;\n                } else {\n                    radio.checked = false;\n                }\n            });\n\n\n            // Check if data.history is already an array, if not try parsing it\n            let history;\n            if (Array.isArray(data.history)) {\n                history = data.history;\n            } else {\n                try {\n                    history = JSON.parse(data.history);\n                } catch (e) {\n                    console.error(`Error parsing history for conversation ${conversationId}: ${e}`);\n                    return;\n                }\n            }\n        \n            // Clear the chat\n            $(\'#chat\').empty();\n\n            let lastRole = null;  // added to keep track of the last role\n\n            // Add each message to the chat. Style the messages based on their role.\n            history.forEach(message => {\n                    let prefix = \'\';\n                    let messageClass = \'\';\n                    if (message.role === \'system\') {\n                        prefix = \'System: \';\n                        messageClass = \'system-message\';\n                    } else if (message.role === \'user\') {\n                        prefix = \'<i class="far fa-user"></i> \';\n                        messageClass = \'user-message\';\n                    } else if (message.role === \'assistant\') {\n                        prefix = \'<i class="fas fa-robot"></i> \';\n                        messageClass = \'bot-message\';\n                    }\n                    // Use marked to render the message content as HTML\n                    const renderedContent = renderOpenAI(message.content);\n                    $(\'#chat\').append(\'<div class="chat-entry \' + message.role + \' \' + messageClass + \'">\' + prefix + renderedContent + \'</div>\');\n                    lastRole = message.role;  // update the last role\n                }\n            );\n\n            Prism.highlightAll(); // Highlight code blocks\n\n            // Append blank user message if the last message was from the assistant\n            if (lastRole === \'assistant\') {\n            $(\'#chat\').append(\'<div class="chat-entry user user-message"><div class="buffer-message"></div></div>\');\n            }\n  \n            // Important! Update the \'messages\' array with the loaded conversation history\n            messages = history;\n\n            console.log(`Chat updated with messages from conversation id: ${conversationId}`);\n\n            // Scroll to the bottom after populating the chat\n            const chatContainer = document.getElementById(\'chat\');\n            chatContainer.scrollTop = chatContainer.scrollHeight;\n        })\n        .catch(error => {\n            console.error(`Error fetching conversation with id: ${conversationId}. Error: ${error}`);\n        });\n}     \n\n//Record the default height \nvar defaultHeight = $(\'#user_input\').css(\'height\');\n\n// This function is called when the user submits the form.\n$(\'#chat-form\').on(\'submit\', function (e) {\n    console.log(\'Chat form submitted with user input:\', $(\'#user_input\').val());\n    e.preventDefault();\n    var userInput = $(\'#user_input\').val();\n  \n    var userInputDiv = $(\'<div class="chat-entry user user-message">\')\n    .append(\'<i class="far fa-user"></i>\')\n    .append($(\'<span>\').text(userInput));\n  \n    $(\'#chat\').append(userInputDiv);\n    $(\'#chat\').scrollTop($(\'#chat\')[0].scrollHeight); \n\n    messages.push({"role": "user", "content": userInput}); \n\n    var userInputTextarea = $(\'#user_input\');  \n    userInputTextarea.val(\'\');\n    userInputTextarea.css(\'height\', defaultHeight);\n\n    document.getElementById(\'loading\').style.display = \'block\';\n    \n    let requestPayload = {\n        messages: messages, \n        model: model,\n        temperature: selectedTemperature\n    };\n\n    if (activeConversationId !== null) {\n       requestPayload.conversation_id = activeConversationId; \n    }\n    console.log(\'Sending request payload:\', JSON.stringify(requestPayload));\n\n    fetch(\'/chat\', {\n        method: \'POST\',\n        headers: {\n            \'Content-Type\': \'application/json\'\n        },\n        body: JSON.stringify(requestPayload)\n    })\n    .then(response => {\n        console.log(\'Received response from /chat endpoint:\', response);\n\n        document.getElementById(\'loading\').style.display = \'none\';\n\n        if (!response.ok) { // Check if response status code is OK\n            return response.text().then(text => { \n                // Use response.text() instead of response.json() if you suspect the server might be returning HTML error pages.\n                throw new Error(text);  // Throw an error with the server\'s response text.\n            });\n        }\n\n        return response.json();\n    })\n    .then(data => {\n        console.log("Complete server reponse:", data);\n        const renderedBotOutput = marked.parse(data.chat_output);\n        console.log("Rendered bot output:", renderedBotOutput); // Log this to debug\n        $(\'#chat\').append(\'<div class="chat-entry bot bot-message"><i class="fas fa-robot"></i> \' + renderedBotOutput + \'</div>\');\n\n        console.log("Updated chat with server\'s response.");\n\n        $(\'#chat\').scrollTop($(\'#chat\')[0].scrollHeight);  // Scroll to the bottom of the chat\n        Prism.highlightAll();\n        messages.push({"role": "assistant", "content": data.chat_output});\n        updateConversationList();\n\n        // Update the URL with the received conversation_id\n        window.history.pushState({}, \'\', `/c/${data.conversation_id}`);\n\n        if (data.conversation_title) {\n            // Update the title in the UI\n            console.log("Received conversation_title from server:", data.conversation_title);\n            showConversationControls(data.conversation_title);\n\n            // Updating the token data in the UI, assuming your server response includes the necessary token data\n            if (data.usage) {\n            $(\'#prompt-tokens\').text(`Prompt Tokens: ${data.usage.prompt_tokens}`);\n            $(\'#completion-tokens\').text(`Completion Tokens: ${data.usage.completion_tokens}`);\n            $(\'#total-tokens\').text(`Total Tokens: ${data.usage.total_tokens}`);\n        }\n        } else {\n            // If there\'s no title provided, show default\n            console.log("No conversation_title from server. Showing default.");\n            showConversationControls();\n        }    \n        console.log(\'End of chat-form submit function\');\n\n    })\n});\n\n// "New Chat" Button Click Event\ndocument.getElementById("new-chat-btn").addEventListener("click", function() {\n    fetch(\'/reset-conversation\', {\n        method: \'POST\',\n    })\n    .then(response => response.json())\n    .then(data => {\n        console.log(data.message);\n        window.location.href = \'/\'; // Redirect to the base URL\n    })\n    .catch((error) => {\n        console.error(\'Error:\', error);\n    });\n});\n\n\n\n\n// Check if the chat is empty when the page loads\ndocument.addEventListener("DOMContentLoaded", function() {\n    if (!activeConversationId && $(\'#chat\').children().length === 0) {\n        // displaySystemMessage(messages[0]);\n        displaySystemMessage(systemMessages[0].content); // display default system message, using "content" property.\n    }\n});\n\n\n// This function checks if there\'s an active conversation in the session.\nfunction checkActiveConversation() {\n    fetch(\'/get_active_conversation\')\n        .then(response => {\n            if (!response.ok) {\n                throw new Error(`HTTP error! Status: ${response.status}`);\n            }\n            return response.json();\n        })\n        .then(data => {\n            const conversationId = data.conversationId;\n            if (conversationId) {\n                // If there\'s an active conversation ID in the session, load it\n                loadConversation(conversationId);\n                // Show the title, rename and delete buttons\n                $(\'#conversation-title, #edit-title-btn, #delete-conversation-btn\').show();\n            } else {\n                // Hide the title, rename and delete buttons\n                $(\'#conversation-title, #edit-title-btn, #delete-conversation-btn\').hide();\n            }\n        })\n        .catch(error => {\n            console.error(\'Error checking for active conversation:\', error);\n            // Optionally hide the elements in case of an error. Depends on your desired behavior.\n            $(\'#conversation-title, #edit-title-btn, #delete-conversation-btn\').hide();\n        });\n}\n\n\n\n$(document).ready(function() {  // Document Ready (initialization)\n    console.log("Document ready."); // Debug\n\n    // Initialize autosize for the textarea\n    autosize($(\'#user_input\'));\n\n    // Set default title\n    $("#conversation-title").html("AI &infin; UI");\n\n    // Function to update the temperature modal\n    function updateTemperatureModal() {\n        document.querySelectorAll(\'input[name="temperatureOptions"]\').forEach(radio => {\n            radio.checked = parseFloat(radio.value) === selectedTemperature;\n        });\n    }\n\n    // Call this function to start the process\n    fetchAndProcessSystemMessages().then(() => {\n        // The rest of your initialization code\n    });\n\n    // Fetch the current model_name from the backend and initialize the application\n    $.ajax({\n        url: \'/get-current-model\',\n        method: \'GET\',\n        success: function(response) {\n            const apiModelName = response.model_name;\n            const userFriendlyModelName = modelNameMapping(apiModelName);\n            model = apiModelName; // Set the model variable correctly\n            $(\'#dropdownMenuButton\').text(userFriendlyModelName);\n        },\n        error: function(error) {\n            console.error(\'Error fetching current model:\', error);\n        }\n    });\n});\n    \n    // ... other initialization code ...\n\n\n\n\n\n\n\n    // ... other initialization code that should run when the page is fully loaded ...\n'}], 'temperature': 0.7}
